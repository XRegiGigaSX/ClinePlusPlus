<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Database Connection Status</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f7f9fa;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1200px;
            margin: 60px auto;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.07);
            padding: 32px 28px 24px 28px;
        }
        h2 {
            display:flex;
            align-items:center;
            justify-content:space-between;
            font-size:1.3em;
            margin-bottom: 18px;
        }
        .status-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .status-item {
            display: flex;
            align-items: center;
            margin-bottom: 18px;
            font-size: 1.08em;
        }
        .status-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 14px;
            display: inline-block;
        }
        .ok { background: #4caf50; }
        .fail { background: #e53935; }
        .pending { background: #bdbdbd; }
        .error-msg {
            color: #e53935;
            font-size: 0.98em;
            margin-left: 30px;
            margin-top: 2px;
        }
        .action-btn {
            padding: 5px 14px;
            font-size: 0.97em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.18s, color 0.18s;
            margin: 0 2px;
        }
        .primary-btn {
            background: #1976d2;
            color: #fff;
        }
        .primary-btn:hover {
            background: #1251a3;
        }
        .danger-btn {
            background: #fff0f0;
            color: #e53935;
            border: 1px solid #e53935;
        }
        .danger-btn:hover {
            background: #e53935;
            color: #fff;
        }
        .input-label {
            font-size: 0.98em;
            color: #333;
            margin-bottom: 2px;
        }
        .input-field {
            width: 100%;
            padding: 7px 10px;
            border: 1px solid #bbb;
            border-radius: 5px;
            font-size: 1em;
            margin-bottom: 2px;
            background: #f9fafd;
            transition: border 0.18s;
        }
        .input-field:focus {
            border: 1.5px solid #1976d2;
            outline: none;
            background: #fff;
        }
        .loader-inline {
            display: none;
            margin-left: 10px;
            vertical-align: middle;
        }
        .loader-inline svg {
            vertical-align: middle;
        }
        @media (max-width: 900px) {
            .container { max-width: 99vw; }
            table { min-width: 600px; }
        }
        @media (max-width: 600px) {
            .container { max-width: 100vw; padding: 8px 2px; }
            form { flex-direction: column; gap: 8px; }
            table { min-width: 400px; font-size: 0.97em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Database Connection Status</h2>
        <ul class="status-list">
            <li class="status-item" id="postgres-status">
                <span class="status-dot pending"></span>
                PostgreSQL
                <div class="error-msg" id="postgres-error"></div>
            </li>
            <li class="status-item" id="neo4j-status">
                <span class="status-dot pending"></span>
                Neo4j
                <div class="error-msg" id="neo4j-error"></div>
            </li>
            <li class="status-item" id="chroma-status">
                <span class="status-dot pending"></span>
                ChromaDB
                <div class="error-msg" id="chroma-error"></div>
            </li>
            <li class="status-item" id="sqlite-status">
                <span class="status-dot pending"></span>
                SQLite
                <div class="error-msg" id="sqlite-error"></div>
            </li>
        </ul>
    </div>
    <div class="container" style="max-width: 1200px; margin-top: 30px;">
        <h2 style="display:flex; align-items:center; justify-content:space-between; font-size:1.3em; margin-bottom: 18px;">
            <span>Registered Repositories</span>
            <div style="display:flex; gap:10px; align-items:center;">
                <button id="clear-repos-btn" class="action-btn danger-btn">Clear All</button>
                <span id="clear-repos-loader" class="loader-inline"></span>
                <span id="clear-extra-loader" class="loader-inline"></span>
            </div>
        </h2>
        <form id="repo-form" style="margin-bottom:22px; display:flex; gap:18px; align-items:flex-end; flex-wrap:wrap; position:relative; background:#f8fafc; padding:18px 18px 10px 18px; border-radius:8px; box-shadow:0 1px 6px rgba(0,0,0,0.04);">
            <div style="flex:1; min-width:180px;">
                <label for="repo_name" class="input-label">Name</label><br>
                <input type="text" id="repo_name" name="repo_name" required class="input-field">
            </div>
            <div style="flex:2; min-width:320px;">
                <label for="repo_path" class="input-label">Path</label><br>
                <input type="text" id="repo_path" name="repo_path" required class="input-field">
            </div>
            <button id="repo-form-btn" type="submit" class="action-btn primary-btn" style="height:38px;">Register</button>
            <div id="repo-form-progress" style="display:none; flex-direction:column; align-items:flex-start; margin-left:18px; min-width:220px;">
                <div id="repo-form-progress-bar" style="width:100%; height:8px; background:#e0e0e0; border-radius:4px; overflow:hidden; margin-bottom:6px;">
                    <div id="repo-form-progress-bar-inner" style="width:0%; height:100%; background:#1976d2; transition:width 0.4s;"></div>
                </div>
                <span id="repo-form-progress-text" style="font-size:0.98em; color:#1976d2;"></span>
                <div id="repo-form-progress-stack" style="margin-top:8px; max-height:120px; overflow-y:auto;"></div>
            </div>
            <span id="repo-form-msg" style="margin-left:18px; font-size:0.98em;"></span>
        </form>
        <div style="overflow-x:auto;">
        <table id="repo-table" style="width:100%; min-width:900px; border-collapse:collapse; background:#fff; font-size:1.04em;">
            <thead>
                <tr style="background:#f0f2f5;">
                    <th style="padding:10px 14px; border-bottom:1px solid #e0e0e0; text-align:left;">Name</th>
                    <th style="padding:10px 14px; border-bottom:1px solid #e0e0e0; text-align:left;">Path</th>
                    <th style="padding:10px 14px; border-bottom:1px solid #e0e0e0; text-align:left;">Indexed At</th>
                    <th style="padding:10px 14px; border-bottom:1px solid #e0e0e0; text-align:left;">Postgres Table</th>
                    <th style="padding:10px 14px; border-bottom:1px solid #e0e0e0; text-align:left;">Chroma Collection</th>
                    <th style="padding:10px 14px; border-bottom:1px solid #e0e0e0; text-align:left;">Neo4j Graph</th>
                </tr>
            </thead>
            <tbody id="repo-table-body">
                <tr><td colspan="6" style="text-align:center; color:#888; padding:18px;">Loading...</td></tr>
            </tbody>
        </table>
        </div>
    </div>
    <script>
        async function checkStatus() {
            // This endpoint should return a JSON object with status and error for each DB
            // Example: { postgres: {ok: true}, neo4j: {ok: false, error: "msg"}, ... }
            try {
                const res = await fetch('/api/db_status');
                const data = await res.json();
                updateStatus('postgres', data.postgres);
                updateStatus('neo4j', data.neo4j);
                updateStatus('chroma', data.chroma);
                updateStatus('sqlite', data.sqlite);
            } catch (e) {
                // If the backend is unreachable, show all as failed
                ['postgres','neo4j','chroma','sqlite'].forEach(db => {
                    updateStatus(db, {ok: false, error: 'API unreachable'});
                });
            }
        }

        function updateStatus(db, status) {
            const item = document.getElementById(db + '-status');
            const dot = item.querySelector('.status-dot');
            const errorDiv = document.getElementById(db + '-error');
            dot.className = 'status-dot ' + (status.ok ? 'ok' : 'fail');
            errorDiv.textContent = status.ok ? '' : (status.error || 'Connection failed');
        }

        // Initial check on page load
        checkStatus();
        fetchRepositories();

        async function fetchRepositories() {
            const tbody = document.getElementById('repo-table-body');
            try {
                const res = await fetch('/api/repositories');
                const data = await res.json();
                const repos = data.repositories || [];
                if (repos.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#888; padding:18px;">No repositories registered.</td></tr>';
                    return;
                }
                tbody.innerHTML = repos.map(r => `
                    <tr>
                        <td style="padding:7px 10px; border-bottom:1px solid #f0f0f0;">${r.repo_name}</td>
                        <td style="padding:7px 10px; border-bottom:1px solid #f0f0f0; font-size:0.97em; color:#444;">${r.repo_path}</td>
                        <td style="padding:7px 10px; border-bottom:1px solid #f0f0f0;">${r.indexed_at}</td>
                        <td style="padding:7px 10px; border-bottom:1px solid #f0f0f0; font-size:0.97em; color:#1976d2;">
                            <a href="pg_table.html?table=${encodeURIComponent(r.postgres_table_name)}" target="_blank" style="color:#1976d2; text-decoration:underline;">${r.postgres_table_name}</a>
                        </td>
                        <td style="padding:7px 10px; border-bottom:1px solid #f0f0f0; font-size:0.97em; color:#1976d2;">
                            <a href="chroma_collection.html?collection=${encodeURIComponent(r.chroma_collection_name)}" target="_blank" style="color:#1976d2; text-decoration:underline;">${r.chroma_collection_name}</a>
                        </td>
                        <td style="padding:7px 10px; border-bottom:1px solid #f0f0f0; font-size:0.97em; color:#444;">${r.neo4j_graph_name}</td>
                    </tr>
                `).join('');
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#e53935; padding:18px;">Failed to load repositories.</td></tr>';
            }
        }

        // Handle repository registration form
        document.getElementById('repo-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const name = document.getElementById('repo_name').value.trim();
            const path = document.getElementById('repo_path').value.trim();
            const msg = document.getElementById('repo-form-msg');
            const btn = document.getElementById('repo-form-btn');
            msg.textContent = '';
            msg.style.color = '#222';
            if (!name || !path) {
                msg.textContent = 'Both fields are required.';
                msg.style.color = '#e53935';
                return;
            }
            btn.disabled = true;
            document.getElementById('repo-form-progress').style.display = 'flex';
            setProgress(0, 'Registering repository...');
            startTime = Date.now();
            try {
                // Register repository first
                const res = await fetch('/api/register_repository', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ repo_name: name, repo_path: path })
                });
                const data = await res.json();
                if (data.success) {
                    setProgress(20, 'Repository registered. Chunking and embedding... (0s)');
                    try {
                        let progress = 20;
                        let phase = 0;
                        const phases = [
                            { pct: 20, text: 'Chunking source files' },
                            { pct: 40, text: 'Generating embeddings' },
                            { pct: 60, text: 'Storing in Postgres/ChromaDB' },
                            { pct: 80, text: 'Building knowledge graph (Neo4j): extracting nodes' },
                            { pct: 85, text: 'Building knowledge graph (Neo4j): extracting relationships' },
                            { pct: 90, text: 'Building knowledge graph (Neo4j): writing to Neo4j' },
                        ];
                        const progressInterval = setInterval(() => {
                            const elapsed = formatElapsed(Date.now() - startTime);
                            if (phase < phases.length) {
                                setProgress(phases[phase].pct, `${phases[phase].text}... (${elapsed})`);
                                phase++;
                            } else {
                                progress += Math.random() * 2;
                                if (progress > 95) progress = 95;
                                setProgress(progress, `Finalizing... (${elapsed})`);
                            }
                        }, 800);
                        const chunkRes = await fetch('/api/index_repository', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ repo_path: path })
                        });
                        clearInterval(progressInterval);
                        const elapsed = formatElapsed(Date.now() - startTime);
                        setProgress(100, `Repository registered, indexed, and KG built! (${elapsed})`);
                        const chunkData = await chunkRes.json();
                        // Show step-by-step status if available
                        if (chunkData.step_status) {
                            Object.entries(chunkData.step_status).forEach(([step, status]) => {
                                if (status === 'success') {
                                    addStepMessage(`✔️ ${step} succeeded`);
                                } else if (typeof status === 'string') {
                                    addStepMessage(`❌ ${step} failed: ${status}`);
                                }
                            });
                        }
                        if (chunkData.success) {
                            msg.textContent = `Repository registered, chunked, and KG built! (${chunkData.chunk_count} chunks, ${elapsed})`;
                            msg.style.color = '#4caf50';
                        } else {
                            setProgress(100, 'Indexing completed with errors.');
                            msg.textContent = 'Indexing completed with errors.';
                            msg.style.color = '#e53935';
                        }
                    } catch (err) {
                        setProgress(100, 'Chunking failed.');
                        msg.textContent = 'Chunking failed.';
                        msg.style.color = '#e53935';
                    }
                    document.getElementById('repo-form').reset();
                    fetchRepositories();
                } else {
                    setProgress(100, data.error || 'Registration failed.');
                    msg.textContent = data.error || 'Registration failed.';
                    msg.style.color = '#e53935';
                }
            } catch (err) {
                msg.textContent = 'Registration failed.';
                msg.style.color = '#e53935';
            } finally {
                btn.disabled = false;
                setTimeout(() => {
                    document.getElementById('repo-form-progress').style.display = 'none';
                    setProgress(0, '');
                }, 1200);
            }
        // Progress bar helper
        function setProgress(percent, text) {
            const bar = document.getElementById('repo-form-progress-bar-inner');
            const txt = document.getElementById('repo-form-progress-text');
            bar.style.width = percent + '%';
            txt.textContent = text || '';
            addStepMessage(text);
        }
        // Step message stack
        function addStepMessage(msg) {
            if (!msg) return;
            const stackDiv = document.getElementById('repo-form-progress-stack');
            const newMsg = document.createElement('div');
            newMsg.textContent = msg;
            newMsg.style.fontSize = '0.97em';
            newMsg.style.marginBottom = '2px';
            // Add to bottom for chronological order
            stackDiv.appendChild(newMsg);
            // Optionally, scroll to bottom to show latest
            stackDiv.scrollTop = stackDiv.scrollHeight;
        }
        });
        // Handle clear all repositories
        document.getElementById('clear-repos-btn').addEventListener('click', async function(e) {
            e.preventDefault();
            if (!confirm('Are you sure you want to clear all registered repositories, delete ALL PostgreSQL tables, delete ALL ChromaDB collections, and delete ALL Neo4j graphs?')) return;
            const btn = document.getElementById('clear-repos-btn');
            const loader = document.getElementById('clear-repos-loader');
            btn.disabled = true;
            loader.style.display = 'inline-block';
            try {
                // Clear repositories
                const res = await fetch('/api/clear_repositories', { method: 'POST' });
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Failed to clear repositories.');
                // Clear PSQL tables
                const psqlRes = await fetch('/api/clear_psql_tables', { method: 'POST' });
                const psqlData = await psqlRes.json();
                if (!psqlData.success) throw new Error(psqlData.error || 'Failed to clear PSQL tables.');
                // Clear ChromaDB collections
                const chromaRes = await fetch('/api/clear_chroma_collections', { method: 'POST' });
                const chromaData = await chromaRes.json();
                if (!chromaData.success) throw new Error(chromaData.error || 'Failed to clear ChromaDB collections.');
                // Clear Neo4j graphs
                const neo4jRes = await fetch('/api/clear_neo4j_graphs', { method: 'POST' });
                const neo4jData = await neo4jRes.json();
                if (!neo4jData.success) throw new Error(neo4jData.error || 'Failed to clear Neo4j graphs.');
                fetchRepositories();
                alert('All repositories, PostgreSQL tables, ChromaDB collections, and Neo4j graphs deleted.');
            } catch (err) {
                alert(err.message || 'Failed to clear all data.');
            } finally {
                btn.disabled = false;
                loader.style.display = 'none';
            }
        });
    </script>
</body>
</html>
